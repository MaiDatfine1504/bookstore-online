{% extends 'layouts/base.html' %}

{% block style %}
<style>
    body {
        font-family: 'Times New Roman', Times, serif;
    }

    .navbar-nav {
        margin: 0 auto;
    }

    .tab-content {
        margin-top: 20px;
    }

    .footer {
        background-color: #f1f1f1;
        text-align: center;
        padding: 20px 0;
        margin-top: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Thanh to√°n</h2>

    <ul class="nav nav-tabs" id="checkoutTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'cart' %}active{% endif %}" id="cart-tab" data-bs-toggle="tab" href="#cart" role="tab">üõí Xem gi·ªè h√†ng</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'method' %}active{% endif %}" id="method-tab" data-bs-toggle="tab" href="#method" role="tab">üí≥ Ch·ªçn h√¨nh th·ª©c thanh to√°n</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'address' %}active{% endif %}" id="address-tab" data-bs-toggle="tab" href="#address" role="tab">üè† ƒê·ªãa ch·ªâ giao h√†ng</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'result' %}active{% endif %}" id="result-tab" data-bs-toggle="tab" href="#result" role="tab">‚úÖ K·∫øt qu·∫£</a>
        </li>
    </ul>

    <div class="tab-content" id="checkoutTabsContent">
        <!-- Cart Tab -->
        <div class="tab-pane fade {% if tab == 'cart' %}show active{% endif %}" id="cart" role="tabpanel">
            <h4>Gi·ªè h√†ng c·ªßa b·∫°n</h4>
            <form id="cart-form" method="POST" action="{{ url_for('checkout_selected') }}">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>S√°ch</th>
                            <th>T√°c gi·∫£</th>
                            <th>Gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>T·ªïng</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_books" value="{{ item.id }}">
                            </td>
                            <td>{{ item.title }}</td>
                            <td>{{ item.author }}</td>
                            <td>{{ "{:,.0f}".format(item.price) }}ƒë</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ "{:,.0f}".format(item.price * item.quantity) }}ƒë</td>
                            <td>
                                <button type="submit"
                                        class="btn btn-sm btn-danger"
                                        formaction="{{ url_for('remove_from_cart', book_id=item.id) }}"
                                        formmethod="post">
                                    Xo√°
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="submit" class="btn btn-success mt-3">Ti·∫øn h√†nh thanh to√°n</button>
            </form>
        </div>

        <!-- Payment Method Tab -->
        <div class="tab-pane fade {% if tab == 'method' %}show active{% endif %}" id="method" role="tabpanel">
            <h4>Ch·ªçn h√¨nh th·ª©c thanh to√°n</h4>
            <form method="POST" action="{{ url_for('checkout') }}">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="online" value="online" {% if payment_method == 'online' %}checked{% endif %} required>
                    <label class="form-check-label" for="online">Thanh to√°n Online</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="offline" value="offline" {% if payment_method == 'offline' %}checked{% endif %} required>
                    <label class="form-check-label" for="offline">Thanh to√°n khi nh·∫≠n h√†ng</label>
                </div>
                <button type="submit" class="btn btn-primary mt-3">X√°c nh·∫≠n h√¨nh th·ª©c thanh to√°n</button>
            </form>
        </div>

        <!-- Address Tab -->
        <div class="tab-pane fade {% if tab == 'address' %}show active{% endif %}" id="address" role="tabpanel">
            <h4>ƒê·ªãa ch·ªâ giao h√†ng</h4>
            <form method="POST" action="{{ url_for('submit_address') }}">
                {% for field in ['house_number', 'street', 'ward', 'district', 'city', 'country'] %}
                <div class="mb-3">
                    <label for="{{ field }}" class="form-label">{{ field.replace('_', ' ').title() }}</label>
                    <input type="text" class="form-control" id="{{ field }}" name="{{ field }}" value="{{ address[field] if address and field in address else '' }}" required>
                </div>
                {% endfor %}
                <button type="submit" class="btn btn-success">L∆∞u ƒë·ªãa ch·ªâ</button>
            </form>
        </div>

        <!-- Result Tab -->
        <div class="tab-pane fade {% if tab == 'result' %}show active{% endif %}" id="result" role="tabpanel">
            <h4>K·∫øt qu·∫£ thanh to√°n</h4>
            {% if receipt %}
            <p>M√£ h√≥a ƒë∆°n: <strong>{{ receipt.id }}</strong></p>
            <p>T·ªïng ti·ªÅn: <strong>{{ "{:,.0f}".format(receipt.total_price) }}ƒë</strong></p>
            <p>Ph∆∞∆°ng th·ª©c: <strong>{{ payment_method|capitalize }}</strong></p>
            <h5>Chi ti·∫øt h√≥a ƒë∆°n</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>S√°ch</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in receipt.details %}
                    <tr>
                        <td>{{ d.book.title }}</td>
                        <td>{{ d.quantity }}</td>
                        <td>{{ "{:,.0f}".format(d.unit_price) }}ƒë</td>
                        <td>{{ "{:,.0f}".format(d.quantity * d.unit_price) }}ƒë</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Ch∆∞a c√≥ h√≥a ƒë∆°n ƒë·ªÉ hi·ªÉn th·ªã.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const activeTab = "{{ tab }}";
        if (activeTab) {
            const tabTrigger = document.querySelector(`#${activeTab}-tab`);
            if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
        }
    });
</script>
{% endblock %}